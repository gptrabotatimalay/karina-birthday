# 🏗️ Архитектура Karina's RPG Quest

## 🎯 Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                        BROWSER                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    index.html                           │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │          Phaser 3 Game Instance                   │  │ │
│  │  │                                                    │  │ │
│  │  │  ┌──────────────────────────────────────────┐    │  │ │
│  │  │  │         Scene Manager                     │    │  │ │
│  │  │  │                                            │    │  │ │
│  │  │  │  ┌───────────┐  ┌────────────┐  ┌──────┐ │    │  │ │
│  │  │  │  │BootScene  │→│PreloadScene│→│ Game │ │    │  │ │
│  │  │  │  │           │  │            │  │Scene │ │    │  │ │
│  │  │  │  └───────────┘  └────────────┘  └──────┘ │    │  │ │
│  │  │  └──────────────────────────────────────────┘    │  │ │
│  │  │                                                    │  │ │
│  │  │  ┌──────────────────────────────────────────┐    │  │ │
│  │  │  │        Physics Engine (Arcade)            │    │  │ │
│  │  │  └──────────────────────────────────────────┘    │  │ │
│  │  │                                                    │  │ │
│  │  │  ┌──────────────────────────────────────────┐    │  │ │
│  │  │  │        Asset Loader                       │    │  │ │
│  │  │  └──────────────────────────────────────────┘    │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 Жизненный цикл игры

```
┌──────────────┐
│   START      │
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│   BootScene          │ ← Показ экрана загрузки
│                      │   Инициализация системы
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   PreloadScene       │ ← Загрузка всех ассетов
│                      │   Спрайты, тайлсеты, звуки
│  - characters/       │
│  - tilesets/         │
│  - furniture/        │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   GameScene          │ ← Основная игра
│                      │
│  ┌────────────────┐  │
│  │ Create Phase   │  │ ← Создание мира и объектов
│  │ - World        │  │
│  │ - Camera       │  │
│  │ - Characters   │  │
│  │ - UI           │  │
│  └────────┬───────┘  │
│           │          │
│           ▼          │
│  ┌────────────────┐  │
│  │ Update Loop    │◄─┼─ 60 FPS
│  │ (60 FPS)       │  │
│  │ - Input        │  │
│  │ - Physics      │  │
│  │ - AI           │  │
│  │ - Animations   │  │
│  │ - Depth Sort   │  │
│  └────────────────┘  │
└──────────────────────┘
```

---

## 🎮 Система сцен (Scene System)

### BootScene

```javascript
Задачи:
  ✓ Показать красивый экран загрузки
  ✓ Инициализировать базовые системы
  ✓ Переход на PreloadScene

Визуал:
  - Прогресс-бар
  - Процент загрузки
  - Фоновый цвет
```

### PreloadScene

```javascript
Задачи:
  ✓ Загрузить все ассеты:
    - Спрайт-листы персонажей (karina, dasha, reksi)
    - Тайлсеты (floor, walls, furniture)
    - Отдельные спрайты мебели
    - Tilemap JSON (apartment)
  ✓ Обработка ошибок загрузки
  ✓ Переход на GameScene

Обработка отсутствующих ассетов:
  - Показ инструкции пользователю
  - Переход в демо-режим по ПРОБЕЛ
```

### GameScene

```javascript
Задачи:
  ✓ Создать игровой мир (комната Карины)
  ✓ Инициализировать персонажей
  ✓ Настроить физику и коллизии
  ✓ Создать UI
  ✓ Обрабатывать ввод
  ✓ Обновлять игровую логику каждый фрейм

Основные методы:
  create()  → Инициализация
  update()  → Игровой цикл (60 FPS)
```

---

## 👥 Система сущностей (Entity System)

```
┌────────────────────────────────────────────────┐
│     Phaser.Physics.Arcade.Sprite               │
│              (Базовый класс)                   │
└────────────┬───────────────────────────────────┘
             │
      ┌──────┴──────┬──────────────┐
      │             │              │
      ▼             ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Player   │  │   NPC    │  │   Cat    │
│          │  │          │  │          │
│ - WASD   │  │ - Диалог │  │ - AI     │
│ - Анимац.│  │ - Статич.│  │ - Блужд. │
│ - Depth  │  │ - Depth  │  │ - Depth  │
└──────────┘  └──────────┘  └──────────┘
```

### Player (Карина)

```javascript
Свойства:
  - speed: 160          // Скорость движения
  - texture: 'karina'   // Спрайт-лист
  - animations: 8       // 4 направления × 2 (walk/idle)

Возможности:
  ✓ Движение WASD
  ✓ Плавная анимация ходьбы
  ✓ Idle анимации
  ✓ Нормализация диагонального движения
  ✓ Автоматический depth sorting

Управление:
  W → Вверх
  A → Влево
  S → Вниз
  D → Вправо
  E → Взаимодействие
```

### NPC (Даша)

```javascript
Свойства:
  - name: 'Даша'
  - dialogue: string
  - isInteractable: true
  - immovable: true    // Статичная позиция

Возможности:
  ✓ Анимация сидения
  ✓ Диалоговое окно при взаимодействии
  ✓ Коллизия с игроком
  ✓ Depth sorting

Взаимодействие:
  Игрок подходит + нажимает E → Показывается диалог
```

### Cat (Рекси)

```javascript
Свойства:
  - speed: 60
  - wanderCooldown: 2000-5000ms
  - states: [walk, idle, sleep]

AI Поведение:
  30% → Блуждание (случайное направление)
  40% → Стоит (idle анимация)
  30% → Спит

Взаимодействие:
  Игрок подходит + нажимает E → Мяуканье
```

---

## 🌍 Система мира (World System)

```
┌─────────────────────────────────────────────────────────┐
│                  Комната Карины (700×550px)             │
│                                                          │
│  ┌─────┐                                                │
│  │ Окно│     ┌──────┬──────┬──────┐  ┌────────┐        │
│  └─────┘     │Тумб. │ Стол │ Стол │  │ Доска  │        │
│              └──────┴──────┴──────┘  └────────┘        │
│  ┌──────────┐         💻💻🎮                             │
│  │          │                                           │
│  │  Кровать │              (○) Пуфик   📚 Полки        │
│  │          │                                           │
│  └──────────┘                                     🚪    │
│                                                          │
│        🛋️                                               │
│      Диван (Даша)                                       │
│                                                          │
│                  🏠 Домик Рекси     📀 Винил            │
│                       🐱                                 │
│                                                   🚪     │
│  🚪                                                      │
└─────────────────────────────────────────────────────────┘

Двери:
  → Кухня (справа)
  → Коридор (снизу справа)
  → Ванная (снизу слева)
```

---

## 🎨 Система Depth Sorting (2.5D)

```
Принцип работы:
  depth = y_coordinate

Объект с большим Y = ближе к камере = выше depth

Пример:

     Y=100  ┌───────┐
            │ Шкаф  │ depth=100
            └───────┘
              🧍‍♀️ Карина Y=150, depth=150

     Y=200  ┌───────┐
            │ Диван │ depth=200
            └───────┘
              🧍‍♀️ Карина Y=250, depth=250

Результат:
  Карина визуально находится ПЕРЕД шкафом
  Карина визуально находится ПЕРЕД диваном

Реализация:
  // В методе update() каждого объекта
  this.setDepth(this.y);
```

---

## ⚙️ Система физики (Physics System)

```
Phaser Arcade Physics
│
├── World Bounds: 1600×1200px
│
├── Игрок (Dynamic Body)
│   ├── velocity: управляется WASD
│   ├── collideWorldBounds: true
│   └── bodySize: 24×32
│
├── Мебель (Static Bodies)
│   ├── immovable: true
│   ├── colliders: кровать, диван
│   └── invisible colliders
│
└── Коллизии
    ├── Player ↔ Мебель
    ├── Player ↔ NPC
    ├── Player ↔ Cat
    └── Cat ↔ Мебель
```

---

## 🎬 Система анимаций

```
Спрайт-лист формат:
  karina.png (128×192px)
  ├── Фреймы 0-3:   walk-down
  ├── Фреймы 4-7:   walk-left
  ├── Фреймы 8-11:  walk-right
  └── Фреймы 12-15: walk-up

Анимации создаются в классе:
  Player.createAnimations()

Воспроизведение:
  this.play('karina-walk-down', true)

Idle анимации:
  Используют первый фрейм каждого направления
  'karina-idle-down' → фрейм 0
```

---

## 🎯 Система взаимодействия

```
┌──────────────────────────────────────────┐
│  Нажата клавиша E                        │
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│  Расчёт дистанции до объектов            │
│  distance = sqrt((x2-x1)² + (y2-y1)²)   │
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│  distance < 60px ?                       │
└──────┬───────────────────────┬───────────┘
       │ ДА                    │ НЕТ
       ▼                       ▼
┌─────────────────┐    ┌──────────────┐
│ NPC.interact()  │    │ Ничего       │
│ Cat.interact()  │    └──────────────┘
└─────────────────┘
       │
       ▼
┌─────────────────┐
│ Показать диалог │
│ или реакцию     │
└─────────────────┘
```

---

## 📱 Система UI

```
┌────────────────────────────────────────────────────┐
│  [WASD - Движение | E - Взаимодействие]           │  ← Панель управления
│                                                    │
│           Karina's RPG Quest                       │  ← Название игры
│                                                    │
│                                                    │
│                  [ИГРОВОЙ МИР]                     │
│                                                    │
│                                                    │
│                                                    │
│ ┌────────────────────────────────────────────┐    │
│ │  Даша:                                      │    │  ← Диалоговое окно
│ │  Привет, Карина! Как дела?                 │    │
│ └────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────┘

Элементы UI:
  - Все имеют setScrollFactor(0)    → Фиксированы на экране
  - Все имеют высокий depth (>900)  → Поверх игрового мира
```

---

## 🔄 Главный игровой цикл

```javascript
update(time, delta) {
  // 60 раз в секунду

  1. Обработка ввода
     └─→ Player.update(cursors, keys)
         ├─ Чтение WASD
         ├─ Установка velocity
         ├─ Обновление анимации
         └─ Depth sorting

  2. Обновление NPC
     └─→ NPC.update()
         └─ Depth sorting

  3. Обновление AI
     └─→ Cat.update(time, delta)
         ├─ Таймер блуждания
         ├─ Смена состояния
         ├─ Анимация
         └─ Depth sorting

  4. Phaser автоматически:
     ├─ Физический движок
     ├─ Проверка коллизий
     ├─ Рендеринг спрайтов
     └─ Обновление камеры
}
```

---

## 🎥 Система камеры

```javascript
Конфигурация:
  - Размер: 1280×720 (видимая область)
  - Границы: 1600×1200 (мир игры)
  - Режим: Follow (следует за игроком)
  - Плавность: 0.1 (lerp)
  - Zoom: 1.2

Поведение:
  Камера центрируется на Player
  Плавно следует за движением
  Не выходит за границы мира
```

---

## 💾 Потенциальные расширения

### Система сохранения

```
SaveSystem
  ├── save(data)      → localStorage
  ├── load()          → JSON parse
  └── deleteSave()    → clear storage
```

### Система квестов

```
QuestManager
  ├── quests: Map<id, Quest>
  ├── addQuest(quest)
  ├── completeObjective(id, index)
  └── getActiveQuests()
```

### Система инвентаря

```
Inventory
  ├── items: Array
  ├── maxSlots: 20
  ├── addItem(item)
  ├── removeItem(id)
  └── hasItem(id)
```

---

## 📊 Производительность

```
Целевой FPS: 60

Оптимизации:
  ✓ Статические физические тела для мебели
  ✓ Минимальное количество активных анимаций
  ✓ Эффективный depth sorting
  ✓ Vite для быстрой HMR разработки

Рекомендации:
  - Использовать sprite atlases вместо отдельных файлов
  - Ограничить количество физических тел
  - Отключить debug режим в продакшене
```

---

## 🔧 Инструменты разработки

```
┌─────────────┐
│   Vite      │ → Dev-сервер с HMR
└─────────────┘
      │
      ▼
┌─────────────┐
│  Phaser 3   │ → Игровой движок
└─────────────┘
      │
      ▼
┌─────────────┐
│   Browser   │ → Chrome/Firefox DevTools
└─────────────┘

Hot Module Replacement (HMR):
  Изменения в коде → Автоматически перезагружается
```

---

## 🎯 Заключение

Архитектура построена на:
  ✓ Модульности (классы для каждой сущности)
  ✓ Расширяемости (легко добавлять новые системы)
  ✓ Производительности (оптимизированная физика)
  ✓ Читаемости (понятная структура кода)

**Создано с ❤️ для Карины**
